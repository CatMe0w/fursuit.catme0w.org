---
import BaseLayout, { type BackButtonMode } from "./BaseLayout.astro";
import TimeMachineBackButton from "../components/TimeMachineBackButton.svelte";

interface Props {
  title: string;
  description?: string;
  pageTitle?: string;
  pageSubtitle?: string;
  pageTitleLink?: string;
  backButton?: BackButtonMode;
  forceFullWidth?: boolean;
}

const {
  title,
  description,
  pageTitle = "æ¡£æ¡ˆé¦†",
  pageSubtitle = "æµè§ˆfursuitå§çš„æ‰€æœ‰å¸–å­ï¼ŒåŒ…æ‹¬å·²åˆ é™¤çš„å†…å®¹ã€‚",
  pageTitleLink = "/archive",
  backButton = "archive", // é»˜è®¤æ˜¾ç¤º"è¿”å›å§é¦–é¡µ"
  forceFullWidth = false,
} = Astro.props;

let finalBackButton: BackButtonMode = backButton;

const currentUrl = Astro.url;
const pathname = currentUrl.pathname.replace(/\/$/, "").replace(/.html$/, "");
const searchParams = currentUrl.searchParams;

// æ¡£æ¡ˆé¦†é¦–é¡µï¼Œæ˜¾ç¤º"è¿”å›é¡¹ç›®é¦–é¡µ"
if (pathname === "/archive" && searchParams.toString() === "") {
  finalBackButton = "home";
}

// æ—¶é—´æœºå™¨é¡µé¢ï¼Œä¸ºç§»åŠ¨ç«¯SidebaræŒ‰é’®ä½¿ç”¨ä¸“å±å›¾æ ‡
const isTimeMachine = finalBackButton === "defer";
---

<BaseLayout title={title} description={description} backButton={finalBackButton}>
  <slot name="head" slot="head" />

  <div id="everything" class="bg-gray-50 min-h-screen">
    <header class="bg-white border-b-2 border-gray-100 hidden lg:block">
      <div class="max-w-5xl mx-auto p-6 mt-12">
        <div class="mb-12">
          <h1 class="text-3xl mb-3"><a href={pageTitleLink} class="hover:text-sky-700" id="page-title">{pageTitle}</a></h1>
          <p id="page-subtitle">{pageSubtitle}</p>
        </div>
        <div class="flex flex-row items-baseline gap-2">
          {
            finalBackButton === "defer" ? (
                <span id="back-to-home-link" class="mb-4">&nbsp;</span>
                <TimeMachineBackButton variant="desktop" client:load />
            ) : finalBackButton === "archive" ? (
              <a href="/archive" id="back-to-home-link" class="text-sky-700 hover:underline grow text-left my-2 cursor-pointer">
                è¿”å›å§é¦–é¡µ
              </a>
            ) : finalBackButton === "home" ? (
              <a href="/" id="back-to-home-link" class="text-sky-700 hover:underline grow text-left my-2 cursor-pointer">
                è¿”å›é¡¹ç›®é¦–é¡µ
              </a>
            ) : null
          }
        </div>
      </div>
    </header>

    <main>
      <div class="flex flex-col lg:flex-row max-w-5xl mx-auto relative">
        <div class={`w-full ${forceFullWidth ? "" : "lg:basis-3/4 lg:order-2"}`}>
          <slot />
        </div>

        <div
          id="sidebar-container"
          class={`fixed inset-0 z-50 bg-white/90 backdrop-blur-sm transition-all duration-250 ease-in-out translate-y-12 opacity-0 pointer-events-none ${
            forceFullWidth
              ? "lg:max-w-5xl lg:mx-auto"
              : "lg:static lg:z-auto lg:bg-transparent lg:backdrop-blur-none lg:basis-1/4 lg:max-w-[25%] lg:order-3 lg:translate-y-0 lg:opacity-100 lg:pointer-events-auto"
          }`}
        >
          <div class={`h-full overflow-y-auto p-6 lg:h-auto lg:overflow-visible ${forceFullWidth ? "lg:max-w-5/12 lg:mx-auto" : "lg:p-0"}`}>
            <slot name="sidebar" />
            <div class="h-24 lg:hidden"></div>
          </div>

          <button
            id="sidebar-close"
            class={`fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg z-50 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer ${
              forceFullWidth ? "" : "lg:hidden"
            }`}
          >
            <span class="sr-only">å…³é—­ä¾§è¾¹æ </span>
            <svg class="size-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </main>

    <div id="back-to-top-container" class="fixed bottom-4 inset-x-0 z-40 hidden pointer-events-none transition-opacity duration-300 opacity-0">
      <div class="max-w-5xl mx-auto relative h-0">
        <button
          onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
          class={`absolute bottom-0 ml-3 bg-blue-600 text-white p-4 rounded-full shadow-lg pointer-events-auto hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer transition-transform ${forceFullWidth ? " left-full mb-18" : " lg:left-[75%]"}`}
          title="å›åˆ°é¡¶éƒ¨"
        >
          <span class="sr-only">å›åˆ°é¡¶éƒ¨</span>
          <svg class="size-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="fixed bottom-4 inset-x-0 z-40 pointer-events-none">
      <div class="max-w-5xl mx-auto relative h-0">
        <button
          id="sidebar-toggle"
          class={`fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg z-40 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 cursor-pointer pointer-events-auto transition-opacity duration-300 ${
            forceFullWidth ? "lg:absolute lg:bottom-0 lg:right-auto lg:left-full lg:ml-3" : "lg:hidden"
          }`}
        >
          <span class="sr-only">æ‰“å¼€ä¾§è¾¹æ </span>
          {
            isTimeMachine ? (
              <svg class="size-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
            ) : (
              <svg class="size-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
              </svg>
            )
          }
        </button>
      </div>
    </div>

    <footer>
      <div class="pb-8 lg:pb-12 mt-6 lg:mt-10 flex flex-col items-center gap-2">
        <p class="text-gray-500 mb-6 text-center lg:hidden"><button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="cursor-pointer underline">å›åˆ°é¡¶éƒ¨</button></p>
        <a href="https://github.com/CatMe0w/fursuit.catme0w.org" target="_blank" title="GitHub Stars">
          <img class="mx-auto" src="https://img.shields.io/github/stars/CatMe0w/fursuit.catme0w.org.svg?style=social&label=Star&maxAge=2592000" alt="GitHub Stars" />
        </a>
        <p class="text-gray-500 text-sm text-center">with ğŸ’– from <a href="https://catme0w.org" target="_blank" class="underline">catme0w</a></p>
      </div>
    </footer>
  </div>

  <script>
    const toggleSidebar = () => {
      const sidebar = document.getElementById("sidebar-container");
      const sidebarToggle = document.getElementById("sidebar-toggle");

      if (sidebar) {
        sidebar.classList.toggle("translate-y-12");
        sidebar.classList.toggle("translate-y-0");
        sidebar.classList.toggle("opacity-0");
        sidebar.classList.toggle("opacity-100");
        sidebar.classList.toggle("pointer-events-none");
        sidebar.classList.toggle("pointer-events-auto");

        const isOpen = sidebar.classList.contains("translate-y-0");

        if (isOpen) {
          document.body.style.overflow = "hidden";
          sidebarToggle?.classList.add("opacity-0", "pointer-events-none");
        } else {
          document.body.style.overflow = "";
          sidebarToggle?.classList.remove("opacity-0", "pointer-events-none");
        }

        updateBackToTopVisibility();
      }
    };

    document.getElementById("sidebar-toggle")?.addEventListener("click", toggleSidebar);
    document.getElementById("sidebar-close")?.addEventListener("click", toggleSidebar);

    const backToTopContainer = document.getElementById("back-to-top-container");

    const updateBackToTopVisibility = () => {
      if (!backToTopContainer) return;

      const scrollY = window.scrollY;
      const viewportHeight = window.innerHeight;
      const isDesktop = window.innerWidth >= 1024; // lg breakpoint
      const isSidebarOpen = document.getElementById("sidebar-container")?.classList.contains("translate-y-0");

      if (isDesktop && scrollY > viewportHeight && !isSidebarOpen) {
        backToTopContainer.classList.remove("hidden");
        void backToTopContainer.offsetWidth;
        backToTopContainer.classList.remove("opacity-0");
        backToTopContainer.classList.add("opacity-100");
      } else {
        backToTopContainer.classList.remove("opacity-100");
        backToTopContainer.classList.add("opacity-0");
        setTimeout(() => {
          if (backToTopContainer.classList.contains("opacity-0")) {
            backToTopContainer.classList.add("hidden");
          }
        }, 100);
      }
    };

    window.addEventListener("scroll", updateBackToTopVisibility);
    window.addEventListener("resize", updateBackToTopVisibility);
    updateBackToTopVisibility();
  </script>
</BaseLayout>
