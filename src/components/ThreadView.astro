---
import ArchiveLayout from "../layouts/ArchiveLayout.astro";
import Pagination from "./Pagination.svelte";
import ThreadPost from "./ThreadPost.svelte";
import Sidebar from "./Sidebar.astro";
import SearchBox from "./SearchBox.astro";
import ExternalLinkButton from "./ExternalLinkButton.astro";
import { getThreadDetail } from "../lib/data";
import { ITEMS_PER_PAGE } from "../lib/pagination";
import type { Thread } from "../lib/types";
import TimeMachineButton from "./TimeMachineButton.astro";
import VandalWarning from "./VandalWarning.svelte";

interface Props {
  thread: Thread;
  threadId: number;
  currentPage: number;
  title: string;
}

const { thread, threadId, currentPage, title } = Astro.props as Props;

const { posts: sveltePosts, totalCount, moderation_logs: moderationLogs } = getThreadDetail(threadId, currentPage);
const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);

const isAlbum = thread.op_post_content?.some((item) => item.type === "album");
---

<ArchiveLayout title={title} description={`查看帖子：${thread.title}`} forceFullWidth={isAlbum}>
  <div class="bg-gray-50 lg:mx-1 my-2">
    <div class="shadow lg:rounded bg-white">
      <div class="grid grid-cols-1">
        <div class="p-5 border-b-2 border-gray-100 flex flex-row justify-between items-baseline">
          <p class="truncate">{thread.title}</p>
          <div class={currentPage > 1 ? "block" : "hidden lg:block"}>
            <Pagination client:load currentPage={currentPage} totalPages={totalPages} baseUrl={`/thread/${threadId}`} />
          </div>
        </div>
        {sveltePosts[0].floor === 1 && <VandalWarning userId={thread.user_id} />}
        {
          // 只在需要CommentList的分页时（大于十条评论）才加载客户端组件
          sveltePosts.map((post) => {
            const shouldHydrate = post.comments && post.comments.length > 10;
            return shouldHydrate ? (
              <ThreadPost client:visible post={post} moderationLogs={moderationLogs} />
            ) : (
              <ThreadPost post={post} moderationLogs={moderationLogs} />
            );
          })
        }
        <div class="flex p-5 justify-end">
          <Pagination client:load currentPage={currentPage} totalPages={totalPages} baseUrl={`/thread/${threadId}`} forceFullWidth />
        </div>
      </div>
    </div>
  </div>
  <div id="sidebar-container" slot="sidebar">
    <Sidebar searchOnly>
      <SearchBox slot="search" placeholder="搜索全吧" />
    </Sidebar>
    <Sidebar>
      <h1 slot="title">到别处看看</h1>
      <TimeMachineButton currentScope="thread" resourceId={threadId} />
      <a href="/moderation-logs/post" class="bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-600 px-4 py-1.5 rounded block transition-colors">吧务后台日志</a>
      <div class="border-2 border-b border-gray-100 my-1"></div>
      <ExternalLinkButton href={`https://tieba.baidu.com/p/${threadId}`}>原帖（百度贴吧）</ExternalLinkButton>
      <ExternalLinkButton href={`https://web.archive.org/web/*/https://tieba.baidu.com/p/${threadId}`}>原帖（网页存档）</ExternalLinkButton>
    </Sidebar>
  </div>
</ArchiveLayout>

<script>
  // 滚动到锚点（如果有）
  function scrollToHash() {
    const hash = window.location.hash;
    if (hash) {
      const id = hash.substring(1);
      const element = document.getElementById(id);
      if (element) {
        // 1. 立即滚动
        element.scrollIntoView();

        // 2. 使用ResizeObserver监视元素位置，防止图片加载导致布局变化时锚点位置偏移
        const container = document.querySelector(".shadow");
        if (container) {
          const observer = new ResizeObserver(() => {
            element.scrollIntoView();
          });
          observer.observe(container);

          // 用户交互或超时时停止观察
          const stop = () => {
            observer.disconnect();
            window.removeEventListener("wheel", stop);
            window.removeEventListener("touchmove", stop);
            window.removeEventListener("keydown", stop);
          };

          window.addEventListener("wheel", stop);
          window.addEventListener("touchmove", stop);
          window.addEventListener("keydown", stop);

          setTimeout(stop, 3000);
        }
      }
    }
  }

  document.addEventListener("DOMContentLoaded", scrollToHash);
</script>
